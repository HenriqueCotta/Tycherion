flowchart TD
  A["scripts/run_demo.py"] --> B["bootstrap/main.py run_app()"]
  B --> C["_build_observability()"]
  C -->|if OTel deps/config| D["Adapter: OtelObservability"]
  C -->|fallback| Dn["Adapter: NoopObservability"]
  D --> OP["ObservabilityPort facade"]
  Dn --> OP

  subgraph CORE["Core (application + domain)"]
    direction TB
    R["application/runmodes/live_multimodel.py"] -->|injects ObservabilityPort| P["application/pipeline/service.py"]
    P -->|span events and logs| ECORE["business logic emits via ports"]
  end

  subgraph PORTS["Ports: src/tycherion/ports/observability"]
    direction TB
    TP["TracerProviderPort"] --> T["TracerPort"] --> SC["SpanPort"]
    LP["LoggerProviderPort"] --> LG["LoggerPort"]
    MP["MeterProviderPort"] --> M["MeterPort"]
  end
  CORE --> OP
  OP --> TP & LP & MP

  subgraph ADAPTER["Adapter: src/tycherion/adapters/observability/otel"]
    direction TB
    RES["Resource attrs service.name=tycherion service.instance.id=runner_id deployment.environment"]
    SDKTP["OTel SDK TracerProvider"]
    SDKMP["OTel SDK MeterProvider"]
    WTP["OtelTracerProvider (ports impl)"] --> WT["OtelTracer"] --> WS["OtelSpan"]
    WLP["OtelLoggerProvider"] --> WLG["OtelLogger pretty/json console filters"]
    WMP["OtelMeterProvider"]
    CON["ConsoleRenderer"]
    BSP["BatchSpanProcessor"]
    PMR["PeriodicExportingMetricReader"]
    OTLP_SPAN["OTLP Span Exporter grpc/http"]
    OTLP_METRIC["OTLP Metric Exporter grpc/http"]
    COL["Collector / Alloy"]
  end

  D --> RES --> SDKTP
  D --> SDKMP
  D --> WTP & WLP & WMP
  WTP --> SDKTP
  WLP --> CON
  WLG --> CON
  WS --> CON
  SDKTP --> BSP --> OTLP_SPAN --> COL
  SDKMP --> PMR --> OTLP_METRIC --> COL

  TP --> WTP
  LP --> WLP
  MP --> WMP

  N1["Core never imports opentelemetry.* directly; it uses ports only."]:::note
  N2["Logs can correlate with trace and span context. In production prefer JSON logs."]:::note
  N3["OTLP insecure can be inferred from endpoint scheme or explicitly configured."]:::note

  CORE --- N1
  ADAPTER --- N2
  ADAPTER --- N3

  classDef note fill:#fff7e6,stroke:#f0b429,color:#4a3b00;
