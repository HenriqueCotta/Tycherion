---
id: eb18670e-f616-48e5-8b72-28a183db386f
---
flowchart TD
  %% High-level entry
  A["scripts/run_demo.py"] --> B["bootstrap/main.py<br/>run_app()"]
  B --> C["_build_observability()"]
  C -->|if OTel deps/config| D["Adapter: OtelObservability"]
  C -->|fallback| Dn["Adapter: NoopObservability"]
  D --> OP["ObservabilityPort facade"]
  Dn --> OP

  %% Core layer (no OTel imports)
  subgraph CORE["Core (application + domain)"]
    direction TB
    R["application/runmodes/live_multimodel.py"] -->|injects ObservabilityPort| P["application/pipeline/service.py"]
    P -->|"span events / logs"| ECORE["business logic emits via ports"]
  end

  %% Ports (stable API)
  subgraph PORTS["Ports: src/tycherion/ports/observability"]
    direction TB
    TP["TracerProviderPort"] --> T["TracerPort"] --> SC["SpanPort"]
    LP["LoggerProviderPort"] --> LG["LoggerPort"]
    MP["MeterProviderPort"] --> M["MeterPort"]
  end
  CORE --> OP
  OP --> TP & LP & MP

  %% OTel adapter
  subgraph ADAPTER["Adapter: src/tycherion/adapters/observability/otel"]
    direction TB
    RES["Resource attrs<br/>service.name=tycherion<br/>service.instance.id=runner_id<br/>tycherion.runner_id / run_id<br/>tycherion.schema_version<br/>deployment.environment"]
    SDKTP["OTel SDK TracerProvider"]
    SDKMP["OTel SDK MeterProvider"]
    WTP["OtelTracerProvider (ports impl)"] --> WT["OtelTracer"] --> WS["OtelSpan"]
    WLP["OtelLoggerProvider"] --> WLG["OtelLogger<br/>formats: pretty | json<br/>filters: console_channels"]
    WMP["OtelMeterProvider"]
    CON["ConsoleRenderer<br/>(dev pretty output)"]
    BSP["BatchSpanProcessor"]
    PMR["PeriodicExportingMetricReader"]
    OTLP_SPAN["OTLP Span Exporter<br/>(grpc|http, headers, insecure inferred/overridden)"]
    OTLP_METRIC["OTLP Metric Exporter<br/>(grpc|http)"]
    COL["Collector / Alloy<br/>(Tempo/Loki/Prom etc)"]
  end

  %% Wiring inside adapter
  D --> RES --> SDKTP
  D --> SDKMP
  D --> WTP & WLP & WMP
  WTP --> SDKTP
  WLP --> CON
  WLG --> CON
  WS --> CON
  SDKTP --> BSP --> OTLP_SPAN --> COL
  SDKMP --> PMR --> OTLP_METRIC --> COL

  %% Core calls through ports -> adapter impl
  TP --> WTP
  LP --> WLP
  MP --> WMP

  %% Notes
  N1["Core nunca importa opentelemetry.*; só fala com Ports."]:::note
  N2["Logs correlacionam com trace/span via contexto OTel.<br/>Produção: preferir stdout JSON (TYCHERION_LOG_FORMAT=json)."]:::note
  N3["OTLP insecure é inferido (http → true, https → false) ou forçado via TYCHERION_OTLP_INSECURE."]:::note

  CORE --- N1
  ADAPTER --- N2
  ADAPTER --- N3

  classDef note fill:#fff7e6,stroke:#f0b429,color:#4a3b00;
